<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resumen del pedido | Catering Gil y Román</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="selector.css">
</head>

<body>

<header class="top">
  <h1>Resumen del pedido</h1>
  <p id="infoCliente"></p>
</header>

<main class="contenedor">
  <section class="resumen">
    <h2>Detalles</h2>
    <ul id="listaResumen"></ul>

    <p id="detalleExtras"></p>
    <p id="detallePersonas"></p>
    <p id="detalleDistancia"></p>
    <p id="totalFinal"></p>

    <button id="confirmar">Confirmar pedido</button>
  </section>
</main>

<!-- ✅ EmailJS como script GLOBAL -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script type="module">
import { db } from "./firebase.js";
import {
  collection,
  addDoc,
  doc,
  updateDoc,
  increment,
  serverTimestamp,
  getDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ---------------- DATOS ---------------- */

const datos = JSON.parse(localStorage.getItem("presupuesto"));
if (!datos) {
  alert("No hay presupuesto guardado");
  window.location.href = "index.html";
}

/* ---------------- DOM ---------------- */

const infoCliente = document.getElementById("infoCliente");
const listaResumen = document.getElementById("listaResumen");
const detalleExtras = document.getElementById("detalleExtras");
const detallePersonas = document.getElementById("detallePersonas");
const detalleDistancia = document.getElementById("detalleDistancia");
const totalFinal = document.getElementById("totalFinal");
const confirmarBtn = document.getElementById("confirmar");

infoCliente.innerText = `${datos.nombre} · ${datos.personas} personas`;

/* ---------------- RESUMEN ---------------- */

function renderResumen() {
  listaResumen.innerHTML = "";
  let total = 0;

  (datos.carrito || []).forEach(item => {
    const li = document.createElement("li");
    li.textContent = `${item.nombre} (${item.categoria}) – ${item.precioPersona} € x ${datos.personas}`;
    listaResumen.appendChild(li);
    total += item.total;
  });

  let extrasTxt = "Extras: ";
  for (let e in datos.extras || {}) {
    extrasTxt += `${e} (${datos.extras[e]} €) `;
    total += datos.extras[e];
  }

  detalleExtras.innerText = extrasTxt;
  detallePersonas.innerText = `Personas: ${datos.personas}`;
  detalleDistancia.innerText = "Distancia aproximada: 10 km";

  datos.total = total;
  totalFinal.innerText = `Total final: ${total.toFixed(2)} €`;

  localStorage.setItem("presupuesto", JSON.stringify(datos));
}

/* ---------------- FIREBASE ---------------- */

async function guardarPedido() {
  await addDoc(collection(db, "pedidos"), {
    ...datos,
    fechaCreacion: serverTimestamp()
  });
}

/* ---------------- EMAIL ---------------- */

function enviarEmail() {
  emailjs.init("XTg7lRhg7RNbEGYMB");

  return emailjs.send(
    "service_4olj3be",
    "template_g5jz7ir",
    {
      nombre: datos.nombre,
      telefono: datos.telefono,
      email: datos.email,
      carrito: datos.carrito.map(p => `${p.nombre} (${p.categoria})`).join(", "),
      total: datos.total
    }
  );
}

/* ---------------- CONFIRMAR ---------------- */

confirmarBtn.addEventListener("click", async () => {
  confirmarBtn.disabled = true;
  confirmarBtn.innerText = "Procesando...";

  renderResumen();
  await guardarPedido();
  await enviarEmail();

  window.location.href = "confirmacion.html";
});

/* ---------------- INIT ---------------- */

renderResumen();
</script>

</body>
</html>
