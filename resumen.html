<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resumen del pedido | Catering Gil y RomÃ¡n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="selector.css">
</head>

<body>

  <header class="top">
    <h1>Resumen del pedido</h1>
    <p id="infoCliente"></p>
  </header>

  <main class="contenedor">

    <section class="resumen">
      <h2>Detalles</h2>
      <ul id="listaResumen"></ul>

      <p id="detalleExtras"></p>
      <p id="detallePersonas"></p>
      <p id="detalleDistancia"></p>
      <p id="totalFinal"></p>

      <button id="confirmar">Confirmar pedido</button>
    </section>

  </main>

<script type="module">
import { db } from "./firebase.js";
import { collection, addDoc, doc, updateDoc, increment, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import emailjs from "https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js";

// ðŸ” Cargar datos del presupuesto actualizado
function cargarDatos() {
  const datos = JSON.parse(localStorage.getItem("presupuesto"));
  if (!datos) {
    alert("No hay presupuesto guardado. Redirigiendo...");
    window.location.href = "index.html";
    return null;
  }
  return datos;
}

let datos = cargarDatos();

// Referencias a elementos del DOM
const infoCliente = document.getElementById("infoCliente");
const listaResumen = document.getElementById("listaResumen");
const detalleExtras = document.getElementById("detalleExtras");
const detallePersonas = document.getElementById("detallePersonas");
const detalleDistancia = document.getElementById("detalleDistancia");
const totalFinal = document.getElementById("totalFinal");
const confirmarBtn = document.getElementById("confirmar");

// Mostrar info inicial
infoCliente.innerText = `${datos.nombre} Â· ${datos.personas} personas`;

async function calcularDistancia() {
  // Ejemplo de distancia fija, puedes integrar Google Maps API
  const distanciaKm = 10;
  datos.distanciaKm = distanciaKm;
  detalleDistancia.innerText = `Distancia aproximada: ${distanciaKm} km`;
}

function renderResumen() {
  if (!datos) return;

  listaResumen.innerHTML = "";
  let subtotal = 0;

  // Productos
  (datos.carrito || []).forEach(item => {
    const li = document.createElement("li");
    li.textContent = `${item.nombre} (${item.categoria}) â€“ ${item.precioPersona} â‚¬ x ${datos.personas}`;
    listaResumen.appendChild(li);
    subtotal += (item.total || item.precioPersona * datos.personas);
  });

  // Extras
  let extrasTxt = "Extras: ";
  for (let e in datos.extras || {}) {
    extrasTxt += `${e} (${datos.extras[e]} â‚¬) `;
    subtotal += datos.extras[e] * (e === "Vajilla" ? datos.personas : 1);
  }
  detalleExtras.innerText = extrasTxt;
  detallePersonas.innerText = `NÃºmero de personas: ${datos.personas}`;
  datos.total = subtotal;
  totalFinal.innerText = `Total final: ${subtotal.toFixed(2)} â‚¬`;

  // Guardar de nuevo en localStorage
  localStorage.setItem("presupuesto", JSON.stringify(datos));
}

async function guardarPedido() {
  const pedidosRef = collection(db, "pedidos");
  await addDoc(pedidosRef, { ...datos, fechaCreacion: serverTimestamp() });

  const clienteRef = doc(db, "clientes", datos.telefono);
  const clienteSnap = await getDoc(clienteRef);
  let pedidosTotales = clienteSnap.exists() ? clienteSnap.data().pedidosTotales : 0;

  await updateDoc(clienteRef, {
    pedidosTotales: increment(1),
    totalGastado: increment(datos.total),
    ultimoPedido: serverTimestamp(),
    esFrecuente: (pedidosTotales + 1) >= 3
  });
}

async function enviarEmail() {
  emailjs.init("TU_USER_ID");
  const templateParams = {
    nombre: datos.nombre,
    telefono: datos.telefono,
    email: datos.email,
    fechaEvento: datos.fechaEvento,
    direccion: datos.direccion,
    personas: datos.personas,
    carrito: JSON.stringify(datos.carrito, null, 2),
    extras: JSON.stringify(datos.extras, null, 2),
    total: datos.total
  };
  await emailjs.send("TU_SERVICE_ID", "TU_TEMPLATE_ID", templateParams);
}

confirmarBtn.addEventListener("click", async () => {
  confirmarBtn.disabled = true;
  confirmarBtn.innerText = "Guardando pedido...";

  await calcularDistancia();
  renderResumen();
  await guardarPedido();
  await enviarEmail();

  alert("Pedido confirmado. Â¡Gracias!");
  window.location.href = "confirmacion.html";
});

// Inicial
calcularDistancia();
renderResumen();
</script>

</body>
</html>
