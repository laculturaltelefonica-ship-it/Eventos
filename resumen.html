<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resumen del pedido | Catering Gil y Rom√°n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="selector.css">
</head>

<body>

<header class="top">
  <h1>Resumen del pedido</h1>
  <p id="infoCliente"></p>
</header>

<main class="contenedor">
  <section class="resumen">
    <h2>Detalles</h2>
    <ul id="listaResumen"></ul>

    <p id="detalleExtras"></p>
    <p id="detallePersonas"></p>
    <p id="detalleDistancia"></p>
    <p id="totalFinal"></p>

    <button id="confirmar">Confirmar pedido</button>
  </section>
</main>

<!-- ‚úÖ EmailJS global -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script type="module">
import { db } from "./firebase.js";
import {
  collection,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ---------------- DATOS ---------------- */

const datos = JSON.parse(localStorage.getItem("presupuesto"));

if (!datos) {
  alert("No hay presupuesto guardado");
  window.location.href = "index.html";
}

/* ---------------- DOM ---------------- */

const infoCliente = document.getElementById("infoCliente");
const listaResumen = document.getElementById("listaResumen");
const detalleExtras = document.getElementById("detalleExtras");
const detallePersonas = document.getElementById("detallePersonas");
const detalleDistancia = document.getElementById("detalleDistancia");
const totalFinal = document.getElementById("totalFinal");
const confirmarBtn = document.getElementById("confirmar");

infoCliente.innerText = `${datos.nombre} ¬∑ ${datos.personas} personas`;

/* ---------------- C√ÅLCULO DISTANCIA ---------------- */

function calcularCosteDistancia(distanciaKm) {
  if (!distanciaKm || distanciaKm <= 0) return 0;
  return Math.ceil(distanciaKm / 100) * 40;
}

/* ---------------- RESUMEN ---------------- */

function renderResumen() {
  listaResumen.innerHTML = "";
  let total = 0;

  // üçΩÔ∏è Platos
  (datos.carrito || []).forEach(item => {
    const li = document.createElement("li");
    li.textContent = `${item.nombre} (${item.categoria}) ‚Äì ${item.precioPersona} ‚Ç¨ x ${datos.personas}`;
    listaResumen.appendChild(li);
    total += item.total;
  });

  // ‚ûï Extras
  let extrasTxt = "Extras: ";
  let hayExtras = false;

  for (let e in datos.extras || {}) {
    extrasTxt += `${e} (${datos.extras[e]} ‚Ç¨) `;
    total += datos.extras[e];
    hayExtras = true;
  }

  detalleExtras.innerText = hayExtras ? extrasTxt : "Extras: Ninguno";
  detallePersonas.innerText = `Personas: ${datos.personas}`;

  // üöö Distancia
  const distanciaKm = datos.direccion?.distanciaKm || 0;
  const costeDistancia = calcularCosteDistancia(distanciaKm);

  detalleDistancia.innerText =
    `Distancia: ${distanciaKm.toFixed(2)} km ¬∑ Desplazamiento: ${costeDistancia} ‚Ç¨`;

  total += costeDistancia;

  // üí∞ Total final
  datos.total = total;
  datos.costeDistancia = costeDistancia;

  totalFinal.innerText = `Total final: ${total.toFixed(2)} ‚Ç¨`;

  localStorage.setItem("presupuesto", JSON.stringify(datos));
}

/* ---------------- FIREBASE ---------------- */

async function guardarPedido() {
  await addDoc(collection(db, "pedidos"), {
    ...datos,
    fechaCreacion: serverTimestamp()
  });
}

/* ---------------- EMAIL ---------------- */

function enviarEmail() {
  emailjs.init("XTg7lRhg7RNbEGYMB");

  return emailjs.send(
    "service_4olj3be",
    "template_g5jz7ir",
    {
      nombre: datos.nombre,
      telefono: datos.telefono,
      email: datos.email,
      distancia: `${datos.direccion.distanciaKm.toFixed(2)} km`,
      desplazamiento: `${datos.costeDistancia} ‚Ç¨`,
      total: `${datos.total.toFixed(2)} ‚Ç¨`
    }
  );
}

/* ---------------- CONFIRMAR ---------------- */

confirmarBtn.addEventListener("click", async () => {
  confirmarBtn.disabled = true;
  confirmarBtn.innerText = "Procesando...";

  renderResumen();
  await guardarPedido();
  await enviarEmail();

  window.location.href = "confirmacion.html";
});

/* ---------------- INIT ---------------- */

renderResumen();
</script>

</body>
</html>
